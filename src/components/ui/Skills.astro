---
import type { HTMLAttributes } from 'astro/types';
import { remark } from 'remark';
import remarkHtml from 'remark-html';

interface Area {
    title: string;
    skills: string[];
    class?: string;
}
interface Skillset {
    text?: string;
    emboss?: string;
    areas: Area[];
}

export interface Props extends HTMLAttributes<'div'> {
    mode?: 'default' | 'breakout' | 'bleed' | 'page';
    wrap?: string | string[];
    panel?: string | string[];
    shadow?: boolean | string;
    bg?: string;
    class?: string;
    skillset?: Skillset;
}

type DisplayTheme = {
    shadow?: boolean;
    panel?: string[];
    wrap?: string[];
};

const displayModes: Record<string, DisplayTheme> = {
    default: {
        panel: ['rounded-tight', 'p-(--viewport-safe-inline)'],
        shadow: true,
    },
    breakout: {
        wrap: ['col-[full]'],
        panel: ['p-(--viewport-safe-inline)'],
        shadow: false,
    },
    bleed: {
        wrap: ['-mx-(--viewport-safe-inline)'],
        panel: ['rounded-tight', 'p-(--viewport-safe-inline)'],
        shadow: true,
    },
    page: {
        wrap: ['col-[full]', 'w-full', 'mx-auto', 'container'],
        panel: ['rounded-tight', 'p-(--viewport-safe-inline)'],
        shadow: true,
    },
};

const {
    mode = 'bleed',
    wrap,
    panel,
    shadow,
    bg = 'bg-surface-raised',
    class: className,
    skillset,
    ...rest
} = Astro.props;

const { text, emboss, areas: rawAreas } = skillset as Skillset;

const config = displayModes[mode] ?? displayModes.default;

const shadowEnabled = shadow !== undefined ? shadow : (config.shadow ?? true);

const shadowClasses =
    typeof shadowEnabled === 'string'
        ? shadowEnabled
        : shadowEnabled
          ? 'shadow-raised shadow-shadow-dark/10'
          : null;

const wrapClasses = wrap ?? config?.wrap ?? [];
const panelClasses = panel ?? config?.panel ?? [];

// Shared parser
const parser = remark().use(remarkHtml, { sanitize: false });

// Strip wrapping <p> tags from any markdown that is a single paragraph
const stripParagraph = (html: string) =>
    html.replace(/^<p>(.*)<\/p>\n?$/s, '$1').trim();

// Process titles and skills â€” no <p> ever
const processedAreas = await Promise.all(
    rawAreas.map(async (area) => ({
        titleHtml: stripParagraph(
            await parser.process(area.title).then((r) => String(r))
        ),
        skillsHtml: await Promise.all(
            area.skills.map(async (skill) =>
                stripParagraph(
                    await parser.process(skill).then((r) => String(r))
                )
            )
        ),
        class: area.class,
    }))
);
---

<div
    class:list={['not-rte @container/skills', wrapClasses, className]}
    {...rest}
>
    <div
        class:list={[
            'w-full rounded @min-[99.9vw]/skills:rounded-none',
            panelClasses,
            shadowClasses,
            bg,
            text ?? 'text-content [&_li]:before:text-secondary',
            emboss && emboss,
        ]}
    >
        <ul
            class="grid grid-cols-1 gap-fluid-m @min-[60ch]:grid-cols-2 @min-[96ch]:grid-cols-3"
        >
            <li class="col-span-full *:last:mb-0"><slot /></li>
            {
                processedAreas.map((area) => (
                    <li class:list={[area?.class]}>
                        <h3 set:html={area.titleHtml} />
                        <ul class:list={['list list--checklist']}>
                            {area.skillsHtml.map((html) => (
                                <li set:html={html} />
                            ))}
                        </ul>
                    </li>
                ))
            }
        </ul>
    </div>
</div>
