---
import type { HTMLAttributes } from 'astro/types';
import ModeCover from '~/components/hero/ModeCover.astro';
import ModePlain from '~/components/hero/ModePlain.astro';
import Breadcrumbs from '~/components/ui/Breadcrumbs.astro';
import Prompt from '~/components/ui/Prompt.astro';

type DisplayTheme = {
    wrap?: string[];
    layout?: string[];
    mandatory?: string[];
};

export interface Elements {
    visual?: Visual;
    cover?: Cover;
    copy?: Copy;
}

export interface Visual {
    src: ImageMetadata;
    alt: string;
    widths?: number[];
    densities?: number[];
    width?: number;
    sizes?: string;
    filter?: 'rgb-split' | 'rgb-split-soft' | 'duotone';
    url?: string;
    cell?: string;
    class?: string;
}

export interface ArtDirective {
    src: ImageMetadata;
    media: string;
}

export interface Cover {
    src: ImageMetadata;
    artDirectives?: ArtDirective[];
    widths?: number[];
    sizes?: string;
    alt: string;
    url: string;
    wrapper?: string;
    class?: string;
}

export interface Copy {
    cell?: string | string[];
}

export interface HeroConfig {
    mode?: 'default' | 'cover' | 'work';
    sequence?:
        | 'default'
        | 'glitch'
        | 'slide-only'
        | 'heroic'
        | 'minimal'
        | 'none';
    dark?: boolean;
    wrap?: string | string[];
    layout?: string | string[];
    breadcrumbs?: boolean;
    headline?: string;
    elements?: Elements;
    legibility?: string;
    prompt?: 'swipe' | 'scroll';
    class?: string;
}

export interface Props extends HTMLAttributes<'div'> {
    title: string;
    config?: Partial<HeroConfig>;
}

const { title, config = {}, ...rest } = Astro.props;

const {
    mode = 'default',
    sequence = 'default',
    dark = false,
    wrap: wrapProp,
    layout: layoutProp,
    breadcrumbs = false,
    headline,
    elements,
    legibility: legibilityProp,
    prompt,
    class: className = '',
} = config as HeroConfig;

const heroTitle = headline ?? title;
const textColor =
    legibilityProp ?? (dark ? 'text-content-light' : 'text-content');

const themes: Record<string, DisplayTheme> = {
    default: {
        wrap: ['bg-surface-sunken'],
        layout: ['py-fluid-2xl'],
    },
    cover: {
        wrap: ['bg-surface-sunken'],
        layout: ['shadow-surface-sunk'],
        mandatory: ['inset-shadow-hero overflow-hidden'],
    },
    work: {
        layout: [
            'grid',
            'grid-cols-1',
            'grid-rows-(--gtr-work)',
            'gap-y-fluid-m',
            'pb-fluid-l',
            'lg:h-svh',
            'lg:grid-cols-(--gtc-work)',
            'lg:grid-rows-1',
            '@min-page/page:grid-cols-(--gtc-work)',
        ],
    },
};

const inView = {
    'data-inview': `${mode}`,
};
const theme = themes[mode] ?? themes.default;

const wrapClasses = wrapProp ?? theme?.wrap ?? [];
const layoutClasses = layoutProp ?? theme?.layout ?? [];
const mandatoryClasses = theme?.mandatory ?? [];
---

<div
    id="hero"
    class:list={[
        'relative z-(--z-hero) col-[full]',
        wrapClasses,
        className,
    ].filter(Boolean)}
    {...mode && { 'data-mode': `${mode}` }}
    {...sequence && { 'data-sequence': `${sequence}` }}
    {...inView}
    {...rest}
>
    <div
        class:list={[
            'relative flow-root w-full outline-hidden',
            layoutClasses,
            mandatoryClasses,
            textColor,
        ].filter(Boolean)}
    >
        {
            mode === 'default' && (
                <ModePlain headline={heroTitle}>
                    <slot />
                </ModePlain>
            )
        }

        {
            mode === 'cover' && (
                <>
                    <ModeCover {elements}>
                        <slot />
                    </ModeCover>
                </>
            )
        }

        {mode === 'work' && <slot />}

        {
            prompt && (
                <div class="pointer-events-none absolute bottom-fluid-s left-1/2 z-100 -translate-x-1/2">
                    <Prompt dir="down" type={prompt} />
                </div>
            )
        }
    </div>
    {breadcrumbs && <Breadcrumbs title={title} />}
</div>
