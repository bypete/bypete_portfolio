---
import { type CollectionEntry, getCollection, render } from 'astro:content';
import { formatBlogPosts } from '~/js/utils';
import WorkLayout from '~/layouts/WorkLayout.astro';

export async function getStaticPaths() {
    const workEntries = await getCollection('work');

    const formattedPosts = formatBlogPosts(workEntries, {
        filterOutDrafts: true,
        filterOutFuturePosts: true,
        sortByDate: true,
        limit: undefined,
    });

    const numberOfPosts = formattedPosts.length;

    // Handle empty collection early (optional, but safe)
    if (numberOfPosts === 0) return [];

    return formattedPosts.map((entry, i) => {
        // Circular next: the post after current in the list, or the first if at the end
        const nextPost =
            i + 1 < numberOfPosts ? formattedPosts[i + 1] : formattedPosts[0];

        // Circular previous: the post before current in the list, or the last if at the start
        const prevPost =
            i > 0 ? formattedPosts[i - 1] : formattedPosts[numberOfPosts - 1];

        return {
            params: { id: entry.id },
            props: {
                entry,
                prevPost,
                nextPost,
            },
        };
    });
}

type Props = {
    entry: CollectionEntry<'work'>;
    prevPost: CollectionEntry<'work'>;
    nextPost: CollectionEntry<'work'>;
};

const { entry, prevPost, nextPost } = Astro.props;
const { Content, headings, remarkPluginFrontmatter } = await render(entry);
---

<WorkLayout
    frontmatter={entry.data}
    section={entry.collection}
    minutesRead={remarkPluginFrontmatter.minutesRead}
    {headings}
    {prevPost}
    {nextPost}
>
    <Content />
</WorkLayout>
